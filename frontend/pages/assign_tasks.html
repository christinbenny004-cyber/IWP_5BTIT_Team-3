<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Assign Tasks</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/templatemo-neural-style.css" rel="stylesheet">
	<style>
		body.page-bg{position:relative;min-height:100vh;background-image:url('https://images.unsplash.com/photo-1527430253228-e93688616381?auto=format&fit=crop&w=1950&q=80');background-size:cover;background-position:center;background-attachment:fixed;}
		body.page-bg::before{content:'';position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.65));z-index:-1;}
		.glass-card{background:rgba(255,255,255,0.08);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.15);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);color:#f8f9fa;padding:16px;}
		.glass-card h3{color:#ffffff;margin-bottom:0;}
		.glass-card .form-control,.glass-card .form-select{background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.1);color:#212529;}
		.glass-card .form-control::placeholder{color:#6c757d;}
		.glass-card .btn-primary{background:#0d6efd;border-color:#0d6efd;}
		.glass-card .border{border-color:rgba(255,255,255,0.25)!important;background:rgba(0,0,0,0.15);} 
	</style>
</head>
<body class="page-bg">
	<div class="container my-4 glass-card">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3>Assign Tasks</h3>
			<div class="d-flex gap-2">
				<a class="btn btn-outline-secondary" href="/pages/manage_modules.html?project=">Back to Modules</a>
				<button class="btn btn-dark" id="logoutBtn">Logout</button>
			</div>
		</div>
		<div class="row g-2 mb-3">
			<div class="col-md-4"><input class="form-control" id="task_name" placeholder="Task name"></div>
			<div class="col-md-4"><input class="form-control" id="description" placeholder="Description"></div>
			<div class="col-md-2"><input class="form-control" id="assigned_to" placeholder="Assigned User ID"></div>
			<div class="col-md-2">
				<select id="status" class="form-select"><option>pending</option><option>in-progress</option><option>completed</option></select>
			</div>
			<div class="col-md-12"><button class="btn btn-primary" id="add">Add Task</button></div>
		</div>
		<div id="tasks"></div>
	</div>
	<script>
	const params = new URLSearchParams(location.search);
	const moduleId = params.get('module');
	const projectId = params.get('project');
	document.querySelector('a.btn.btn-outline-secondary').href = `/pages/manage_modules.html?project=${projectId}`;
	async function guard(){
		const res = await fetch('/api/auth/me', { credentials:'include' });
		if (!res.ok) { window.location.href='/pages/login.html'; return false; }
		const me = await res.json();
		if (me.role !== 'leader' && me.role !== 'admin') { window.location.href='/pages/error.html'; return false; }
		return true;
	}
	async function load(){
		const res = await fetch(`/api/projects/modules/${moduleId}/tasks`, { credentials:'include' });
		const list = await res.json();
		document.getElementById('tasks').innerHTML = list.map(t=>`<div class='d-flex justify-content-between align-items-center border rounded p-2 mb-2'>
			<span>${t.task_name}</span>
			<div class='d-flex gap-2'>
				<select class='form-select form-select-sm' data-updatestatus='${t.id}'>
					<option ${t.status==='pending'?'selected':''}>pending</option>
					<option ${t.status==='in-progress'?'selected':''}>in-progress</option>
					<option ${t.status==='completed'?'selected':''}>completed</option>
				</select>
				<button class='btn btn-sm btn-danger' data-del='${t.id}'>Delete</button>
			</div>
		</div>`).join('');
	}
	document.getElementById('add').onclick = async ()=>{
		const payload = { task_name: task_name.value, description: description.value, assigned_to: assigned_to.value ? Number(assigned_to.value) : null, status: status.value };
		await fetch(`/api/projects/modules/${moduleId}/tasks`, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
		load();
	};
	document.addEventListener('change', async (e)=>{
		if (e.target.dataset.updatestatus){
			await fetch(`/api/projects/tasks/${e.target.dataset.updatestatus}`, { method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ status: e.target.value }) });
			load();
		}
	});
	document.addEventListener('click', async (e)=>{
		if (e.target.dataset.del){
			await fetch(`/api/projects/tasks/${e.target.dataset.del}`, { method:'DELETE', credentials:'include' });
			load();
		}
	});
	document.getElementById('logoutBtn').onclick = async ()=>{
		await fetch('/api/auth/logout', { method:'POST', credentials:'include' });
		window.location.href = '/pages/login.html';
	};
	guard().then(ok=>{ if (ok) load(); });
	</script>
</body>
</html>
