<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manage Projects</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

	<style>
		/* Background */
		body.page-bg {
			position: relative;
			min-height: 100vh;
			background-image: url('https://images.unsplash.com/photo-1527430253228-e93688616381?auto=format&fit=crop&w=1950&q=80');
			background-size: cover;
			background-position: center;
			background-attachment: fixed;
			color: #f8f9fa;
			font-family: "Segoe UI", sans-serif;
		}
		body.page-bg::before {
			content: '';
			position: fixed;
			inset: 0;
			background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));
			z-index: -1;
		}

		/* Glass card */
		.glass-card {
			background: rgba(255,255,255,0.08);
			backdrop-filter: blur(8px);
			-webkit-backdrop-filter: blur(8px);
			border: 1px solid rgba(255,255,255,0.15);
			border-radius: 15px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			padding: 20px;
		}
		.glass-card h3 {
			color: #fff;
			font-weight: bold;
		}

		/* Table */
		.table {
			color: #f8f9fa;
			margin-bottom: 0;
		}
		.table thead th {
			background: rgba(255,255,255,0.15);
			color: #fff;
			border-color: rgba(255,255,255,0.25);
		}
		.table-bordered>:not(caption)>* {
			border-color: rgba(255,255,255,0.2);
		}
		.table tbody tr:hover {
			background: rgba(255,255,255,0.08);
			transition: 0.2s;
		}

		/* Buttons */
		.btn {
			border-radius: 8px;
			font-weight: 500;
			transition: 0.2s;
		}
		.btn-outline-secondary {
			color: #f8f9fa;
			border-color: #f8f9fa;
		}
		.btn-outline-secondary:hover {
			background: #f8f9fa;
			color: #212529;
		}
		.btn-dark {
			background: #212529;
			border: none;
		}
		.btn-dark:hover {
			background: #000;
		}
		.btn-secondary {
			background: #6c757d;
			border: none;
		}
		.btn-secondary:hover {
			background: #5a6268;
		}
		.btn-danger {
			background: #dc3545;
			border: none;
		}
		.btn-danger:hover {
			background: #bb2d3b;
		}
	</style>
</head>
<body class="page-bg">
	<div class="container my-5 glass-card">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h3>ðŸ“Š Manage Projects</h3>
			<div class="d-flex gap-2">
				<a class="btn btn-outline-secondary" href="/pages/admin_dashboard.html">â¬… Back</a>
				<button class="btn btn-dark" id="logoutBtn">Logout</button>
			</div>
		</div>

		<table class="table table-bordered table-hover align-middle text-center" id="tbl">
			<thead>
				<tr>
					<th>ID</th>
					<th>Title</th>
					<th>Status</th>
					<th>Progress</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>

	<script>
	async function guard(){
		const res = await fetch('/api/auth/me', { credentials:'include' });
		if (!res.ok) { window.location.href='/pages/login.html'; return false; }
		const me = await res.json();
		if (me.role !== 'admin') { window.location.href='/pages/error.html'; return false; }
		return true;
	}
	async function load(){
		const res = await fetch('/api/projects', { credentials:'include' });
		if (!res.ok) { alert('Unauthorized'); window.location.href='/pages/login.html'; return; }
		const projects = await res.json();
		document.querySelector('#tbl tbody').innerHTML = projects.map(p=>`
			<tr>
				<td>${p.id}</td>
				<td>${p.title}</td>
				<td><span class="badge ${p.status === 'active' ? 'bg-success' : 'bg-secondary'}">${p.status}</span></td>
				<td>
					<div class="progress" style="height:8px; width:150px; margin: auto;">
						<div class="progress-bar" role="progressbar" style="width:${p.progress || 0}%" 
							aria-valuenow="${p.progress || 0}" aria-valuemin="0" aria-valuemax="100"></div>
					</div>
					<small>${p.progress || 0}%</small>
				</td>
				<td>
					<button class='btn btn-sm btn-secondary' data-toggle='${p.id}' data-status='${p.status === 'active' ? 'inactive':'active'}'>
						${p.status === 'active' ? 'Deactivate':'Activate'}
					</button>
					<button class='btn btn-sm btn-danger' data-del='${p.id}'>Delete</button>
				</td>
			</tr>`).join('');
	}
	document.addEventListener('click', async (e)=>{
		if (e.target.dataset.toggle){
			await fetch('/api/projects/'+e.target.dataset.toggle, { 
				method:'PUT', 
				headers:{'Content-Type':'application/json'}, 
				credentials:'include', 
				body: JSON.stringify({ status: e.target.dataset.status }) 
			});
			load();
		}
		if (e.target.dataset.del){
			await fetch('/api/projects/'+e.target.dataset.del, { method:'DELETE', credentials:'include' });
			load();
		}
	});
	document.getElementById('logoutBtn').onclick = async ()=>{
		await fetch('/api/auth/logout', { method:'POST', credentials:'include' });
		window.location.href = '/pages/login.html';
	};
	guard().then(ok=>{ if (ok) load(); });
	</script>
</body>
</html>
